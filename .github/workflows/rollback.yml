name: Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
      target_version:
        description: 'Target version to rollback to (leave empty for previous stable)'
        required: false
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string
  workflow_run:
    workflows: ["Deploy"]
    types:
      - completed

env:
  REGISTRY: ghcr.io

jobs:
  # å›æ»šå†³ç­–
  rollback-decision:
    name: Rollback Decision
    runs-on: ubuntu-latest
    outputs:
      should_rollback: ${{ steps.decision.outputs.should_rollback }}
      target_version: ${{ steps.decision.outputs.target_version }}
      environment: ${{ steps.decision.outputs.environment }}
    steps:
      - name: Make rollback decision
        id: decision
        run: |
          # ç¡®å®šæ˜¯å¦éœ€è¦å›æ»š
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_rollback=true" >> $GITHUB_OUTPUT
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "target_version=${{ github.event.inputs.target_version }}" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Manual rollback requested"
          elif [[ "${{ github.event.workflow_run.conclusion }}" == "failure" ]]; then
            echo "should_rollback=true" >> $GITHUB_OUTPUT
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "target_version=" >> $GITHUB_OUTPUT
            echo "âš ï¸ Automatic rollback triggered by failed deployment"
          else
            echo "should_rollback=false" >> $GITHUB_OUTPUT
            echo "âœ… Deployment successful, no rollback needed"
          fi

  # æŸ¥æ‰¾ç¨³å®šç‰ˆæœ¬
  find-stable-version:
    name: Find Stable Version
    runs-on: ubuntu-latest
    needs: rollback-decision
    if: needs.rollback-decision.outputs.should_rollback == 'true'
    outputs:
      stable_version: ${{ steps.find.outputs.stable_version }}
      stable_tag: ${{ steps.find.outputs.stable_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find stable version
        id: find
        run: |
          TARGET_VERSION="${{ needs.rollback-decision.outputs.target_version }}"

          if [[ -n "$TARGET_VERSION" ]]; then
            # ä½¿ç”¨æŒ‡å®šçš„ç‰ˆæœ¬
            STABLE_VERSION="$TARGET_VERSION"
            STABLE_TAG="v$TARGET_VERSION"
          else
            # æŸ¥æ‰¾æœ€è¿‘çš„ç¨³å®šæ ‡ç­¾
            STABLE_TAG=$(git tag --sort=-version:refname | grep '^v' | head -2 | tail -1)

            if [[ -z "$STABLE_TAG" ]]; then
              echo "âŒ No stable version found"
              exit 1
            fi

            STABLE_VERSION=$(echo "$STABLE_TAG" | sed 's/^v//')
          fi

          echo "stable_version=$STABLE_VERSION" >> $GITHUB_OUTPUT
          echo "stable_tag=$STABLE_TAG" >> $GITHUB_OUTPUT

          echo "ğŸ” Found stable version: $STABLE_VERSION (tag: $STABLE_TAG)"

  # æ‰§è¡Œå›æ»š
  execute-rollback:
    name: Execute Rollback
    runs-on: ubuntu-latest
    needs: [rollback-decision, find-stable-version]
    if: needs.rollback-decision.outputs.should_rollback == 'true'
    environment:
      name: ${{ needs.rollback-decision.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Execute rollback
        run: |
          ENVIRONMENT="${{ needs.rollback-decision.outputs.environment }}"
          STABLE_VERSION="${{ needs.find-stable-version.outputs.stable_version }}"
          STABLE_TAG="${{ needs.find-stable-version.outputs.stable_tag }}"

          echo "ğŸ”„ Executing rollback to $STABLE_VERSION in $ENVIRONMENT environment..."
          echo "Image: ${{ env.REGISTRY }}/${{ github.repository }}:$STABLE_TAG"

          # å›æ»šæ­¥éª¤
          echo "ğŸ“¦ Pulling stable image..."
          sleep 3

          echo "ğŸ”„ Switching to stable version..."
          sleep 5

          echo "ğŸ¥ Running health checks..."
          sleep 3

          echo "âœ… Rollback completed successfully"

      - name: Verify rollback
        run: |
          echo "ğŸ” Verifying rollback..."
          sleep 5
          echo "âœ… Rollback verification passed"

  # å›æ»šåç›‘æ§
  post-rollback-monitoring:
    name: Post-rollback Monitoring
    runs-on: ubuntu-latest
    needs: execute-rollback
    if: always()
    steps:
      - name: Setup monitoring
        run: |
          echo "ğŸ“Š Setting up post-rollback monitoring..."

          # è®¾ç½®é¢å¤–çš„ç›‘æ§
          echo "âœ… Monitoring configured"

      - name: Generate rollback report
        run: |
          echo "## ğŸ”„ Rollback Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Rollback Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.rollback-decision.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Rolled back to**: v${{ needs.find-stable-version.outputs.stable_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Initiated by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Reason**: ${{ github.event.inputs.reason || 'Automatic rollback due to deployment failure' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.execute-rollback.result }}" == "success" ]]; then
            echo "### âœ… Rollback Successful" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”„ Application has been rolled back to stable version" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Rollback Failed" >> $GITHUB_STEP_SUMMARY
            echo "ğŸš¨ Manual intervention required!" >> $GITHUB_STEP_SUMMARY
          fi

  # é€šçŸ¥å›¢é˜Ÿ
  notify-rollback:
    name: Notify Rollback
    runs-on: ubuntu-latest
    needs: [execute-rollback, post-rollback-monitoring]
    if: always()
    steps:
      - name: Send rollback notification
        run: |
          ENVIRONMENT="${{ needs.rollback-decision.outputs.environment }}"
          VERSION="v${{ needs.find-stable-version.outputs.stable_version }}"

          echo "ğŸ“¢ Rollback Notification"
          echo "Environment: $ENVIRONMENT"
          echo "Version: $VERSION"
          echo "Status: ${{ needs.execute-rollback.result }}"

          # è¿™é‡Œå¯ä»¥é›†æˆå„ç§é€šçŸ¥æœåŠ¡
          # Slack, Discord, email ç­‰
