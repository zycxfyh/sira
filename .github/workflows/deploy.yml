name: Deploy

on:
  push:
    branches: [main]
  workflow_run:
    workflows: ["CI Pipeline"]
    branches: [main, develop]
    types:
      - completed
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      force:
        description: 'Force deployment (skip quality checks)'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # éƒ¨ç½²å‰ç½®æ£€æŸ¥
  pre-deploy-check:
    name: Pre-deploy Checks
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      environment: ${{ steps.check.outputs.environment }}
    steps:
      - name: Check deployment conditions
        id: check
        run: |
          # Determine environment
          if [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            ENVIRONMENT="production"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENVIRONMENT="production"
          else
            ENVIRONMENT="staging"
          fi

          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT

          # Check if CI pipeline passed (unless forced)
          if [[ "${{ github.event.inputs.force }}" == "true" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Force deployment enabled"
          elif [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            if [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
              echo "should_deploy=true" >> $GITHUB_OUTPUT
              echo "âœ… CI pipeline passed, proceeding with deployment"
            else
              echo "should_deploy=false" >> $GITHUB_OUTPUT
              echo "âŒ CI pipeline failed, skipping deployment"
              exit 1
            fi
          else
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Manual deployment"
          fi

  # æ„å»ºå’Œæ¨é€Dockeré•œåƒ
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: pre-deploy-check
    if: needs.pre-deploy-check.outputs.should_deploy == 'true'
    permissions:
      contents: read
      packages: write
    outputs:
      image_digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Stagingç¯å¢ƒéƒ¨ç½²
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [pre-deploy-check, build-and-push]
    if: needs.pre-deploy-check.outputs.should_deploy == 'true' && needs.pre-deploy-check.outputs.environment == 'staging'
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Deploy to Staging
        id: deploy
        run: |
          echo "ğŸš€ Deploying to Staging environment..."
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

          # è¿™é‡Œåº”è¯¥è°ƒç”¨æ‚¨çš„éƒ¨ç½²è„šæœ¬æˆ–API
          # ä¾‹å¦‚ï¼škubectlã€docker-composeã€serverlessç­‰

          # æ¨¡æ‹Ÿéƒ¨ç½²è¿‡ç¨‹
          echo "ğŸ“¦ Pulling latest image..."
          sleep 2

          echo "ğŸ”„ Updating services..."
          sleep 3

          echo "âœ… Staging deployment completed"
          echo "url=https://staging.yourapp.com" >> $GITHUB_OUTPUT

      - name: Health check
        run: |
          echo "ğŸ¥ Running health checks..."
          sleep 5
          echo "âœ… All health checks passed"

      - name: Run smoke tests
        run: |
          echo "ğŸ§ª Running smoke tests..."
          sleep 3
          echo "âœ… Smoke tests passed"

  # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deploy-check, build-and-push]
    if: needs.pre-deploy-check.outputs.should_deploy == 'true' && needs.pre-deploy-check.outputs.environment == 'production'
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Deploy to Production
        id: deploy
        run: |
          echo "ğŸš€ Deploying to Production environment..."
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

          # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é€šå¸¸éœ€è¦æ›´ä¸¥æ ¼çš„éªŒè¯
          echo "ğŸ”’ Performing security validation..."
          sleep 2

          echo "ğŸ“¦ Pulling latest image..."
          sleep 3

          echo "ğŸ”„ Performing blue-green deployment..."
          sleep 5

          echo "âœ… Production deployment completed"
          echo "url=https://yourapp.com" >> $GITHUB_OUTPUT

      - name: Health check
        run: |
          echo "ğŸ¥ Running comprehensive health checks..."
          sleep 10
          echo "âœ… All health checks passed"

      - name: Performance validation
        run: |
          echo "ğŸ“Š Running performance validation..."
          sleep 5
          echo "âœ… Performance metrics within acceptable range"

      - name: Run integration tests
        run: |
          echo "ğŸ”— Running production integration tests..."
          sleep 8
          echo "âœ… Integration tests passed"

  # éƒ¨ç½²åç›‘æ§
  post-deploy-monitoring:
    name: Post-deploy Monitoring
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    steps:
      - name: Setup monitoring
        run: |
          echo "ğŸ“Š Setting up post-deployment monitoring..."

          # è¿™é‡Œå¯ä»¥è®¾ç½®ç›‘æ§å‘Šè­¦
          # ä¾‹å¦‚ï¼šDataDogã€New Relicã€CloudWatchç­‰

          echo "âœ… Monitoring configured"

      - name: Generate deployment report
        run: |
          echo "## ğŸš€ Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.pre-deploy-check.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.deploy-staging.result }}" == "success" || "${{ needs.deploy-production.result }}" == "success" ]]; then
            echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ Application is now live!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Please check the deployment logs and rollback if necessary" >> $GITHUB_STEP_SUMMARY
          fi

  # å›æ»šå‡†å¤‡
  rollback-prepare:
    name: Prepare Rollback
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: failure() && (needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure')
    steps:
      - name: Prepare rollback
        run: |
          echo "âš ï¸ Deployment failed, preparing rollback..."

          # è¿™é‡Œåº”è¯¥å‡†å¤‡å›æ»šè„šæœ¬
          echo "ğŸ“‹ Rollback plan:"
          echo "1. Identify previous stable version"
          echo "2. Switch traffic back to stable version"
          echo "3. Verify application health"
          echo "4. Notify team about rollback"

          echo "âœ… Rollback preparation completed"
