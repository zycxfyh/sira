name: Notifications

on:
  workflow_run:
    workflows: ["CI Pipeline", "Deploy", "Release", "Rollback"]
    types: [completed]
  schedule:
    # æ¯å¤©æ—©ä¸Š9ç‚¹å‘é€æ‘˜è¦æŠ¥å‘Š
    - cron: '0 9 * * 1-5'

jobs:
  # CIç»“æœé€šçŸ¥
  ci-notification:
    name: CI Notification
    runs-on: ubuntu-latest
    if: github.event.workflow_run.workflow.name == 'CI Pipeline'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Send CI notification
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          ACTOR="${{ github.event.workflow_run.triggering_actor }}"

          if [[ "$CONCLUSION" == "success" ]]; then
            STATUS="âœ… SUCCESS"
            COLOR="good"
            MESSAGE="All quality gates passed! Ready for deployment."
          elif [[ "$CONCLUSION" == "failure" ]]; then
            STATUS="âŒ FAILED"
            COLOR="danger"
            MESSAGE="CI pipeline failed. Please review the errors."
          else
            STATUS="âš ï¸ CANCELLED"
            COLOR="warning"
            MESSAGE="CI pipeline was cancelled."
          fi

          # Slacké€šçŸ¥ (å¦‚æœé…ç½®äº†SLACK_WEBHOOK)
          if [[ -n "${{ secrets.SLACK_WEBHOOK }}" ]]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{
                \"attachments\": [{
                  \"color\": \"$COLOR\",
                  \"title\": \"CI Pipeline $STATUS\",
                  \"text\": \"$MESSAGE\",
                  \"fields\": [
                    {\"title\": \"Branch\", \"value\": \"$BRANCH\", \"short\": true},
                    {\"title\": \"Triggered by\", \"value\": \"$ACTOR\", \"short\": true},
                    {\"title\": \"Workflow\", \"value\": \"$WORKFLOW_NAME\", \"short\": true}
                  ],
                  \"actions\": [{
                    \"type\": \"button\",
                    \"text\": \"View Details\",
                    \"url\": \"${{ github.event.workflow_run.html_url }}\"
                  }]
                }]
              }" \
              ${{ secrets.SLACK_WEBHOOK }}
          fi

          # Discordé€šçŸ¥ (å¦‚æœé…ç½®äº†DISCORD_WEBHOOK)
          if [[ -n "${{ secrets.DISCORD_WEBHOOK }}" ]]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{
                \"embeds\": [{
                  \"title\": \"CI Pipeline $STATUS\",
                  \"description\": \"$MESSAGE\",
                  \"color\": \"$([[ "$CONCLUSION" == "success" ]] && echo 3066993 || echo 15158332)\",
                  \"fields\": [
                    {\"name\": \"Branch\", \"value\": \"$BRANCH\", \"inline\": true},
                    {\"name\": \"Triggered by\", \"value\": \"$ACTOR\", \"inline\": true}
                  ],
                  \"url\": \"${{ github.event.workflow_run.html_url }}\"
                }]
              }" \
              ${{ secrets.DISCORD_WEBHOOK }}
          fi

  # éƒ¨ç½²é€šçŸ¥
  deploy-notification:
    name: Deploy Notification
    runs-on: ubuntu-latest
    if: github.event.workflow_run.workflow.name == 'Deploy'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Send deploy notification
        run: |
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          ACTOR="${{ github.event.workflow_run.triggering_actor }}"

          # å°è¯•ä»å·¥ä½œæµè¿è¡Œä¸­æå–ç¯å¢ƒä¿¡æ¯
          if [[ "$BRANCH" == "main" ]]; then
            ENVIRONMENT="Production"
          else
            ENVIRONMENT="Staging"
          fi

          if [[ "$CONCLUSION" == "success" ]]; then
            STATUS="ğŸš€ DEPLOYED"
            MESSAGE="Successfully deployed to $ENVIRONMENT environment!"
          elif [[ "$CONCLUSION" == "failure" ]]; then
            STATUS="ğŸ’¥ DEPLOY FAILED"
            MESSAGE="Deployment to $ENVIRONMENT failed. Check logs for details."
          else
            STATUS="â¸ï¸ DEPLOY CANCELLED"
            MESSAGE="Deployment to $ENVIRONMENT was cancelled."
          fi

          # å‘é€é€šçŸ¥ (ç±»ä¼¼ä¸Šé¢çš„Slack/Discordé€»è¾‘)
          echo "$STATUS - $MESSAGE"
          echo "Environment: $ENVIRONMENT"
          echo "Branch: $BRANCH"
          echo "Deployed by: $ACTOR"

  # å‘å¸ƒé€šçŸ¥
  release-notification:
    name: Release Notification
    runs-on: ubuntu-latest
    if: github.event.workflow_run.workflow.name == 'Release'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Get release info
        run: |
          # ä»æ ‡ç­¾ä¸­æå–ç‰ˆæœ¬ä¿¡æ¯
          REF="${{ github.event.workflow_run.head_sha }}"
          TAGS=$(git tag --points-at $REF 2>/dev/null || echo "")

          if [[ -n "$TAGS" ]]; then
            VERSION=$(echo "$TAGS" | head -1)
            echo "ğŸ‰ New release: $VERSION"
            echo "ğŸ“¦ Published by: ${{ github.event.workflow_run.triggering_actor }}"

            # å‘é€å‘å¸ƒé€šçŸ¥
            echo "Release notification would be sent here"
          fi

  # å›æ»šé€šçŸ¥
  rollback-notification:
    name: Rollback Notification
    runs-on: ubuntu-latest
    if: github.event.workflow_run.workflow.name == 'Rollback'
    steps:
      - name: Send rollback alert
        run: |
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"

          if [[ "$CONCLUSION" == "success" ]]; then
            echo "ğŸ”„ Rollback completed successfully"
          else
            echo "ğŸš¨ Rollback failed! Manual intervention required!"
          fi

          # å‘é€é«˜ä¼˜å…ˆçº§å‘Šè­¦
          echo "Rollback notification sent"

  # æ¯æ—¥æ‘˜è¦æŠ¥å‘Š
  daily-summary:
    name: Daily Summary
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Generate daily summary
        run: |
          echo "ğŸ“Š Daily CI/CD Summary Report"
          echo "Date: $(date)"
          echo ""

          # è·å–æœ€è¿‘çš„CIè¿è¡Œ
          echo "Recent CI Pipeline Runs:"
          # è¿™é‡Œå¯ä»¥è°ƒç”¨GitHub APIè·å–å·¥ä½œæµè¿è¡Œç»Ÿè®¡

          echo "Recent Deployments:"
          # éƒ¨ç½²ç»Ÿè®¡

          echo "Active Issues:"
          # é—®é¢˜ç»Ÿè®¡

          # å‘é€æ‘˜è¦æŠ¥å‘Š
          echo "Daily summary sent"
