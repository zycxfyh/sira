name: Performance Monitoring

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œæ€§èƒ½ç›‘æŽ§
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Performance test type'
        required: false
        default: 'comprehensive'
        type: choice
        options:
          - quick
          - comprehensive
          - load-test
          - memory-leak

env:
  NODE_ENV: production

jobs:
  # å¿«é€Ÿæ€§èƒ½æ£€æŸ¥
  quick-performance-check:
    name: Quick Performance Check
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule' || github.event_name != 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Quick startup time check
        run: |
          echo "ðŸš€ Measuring startup time..."
          START_TIME=$(date +%s%3N)
          timeout 30s npm start &
          SERVER_PID=$!
          sleep 3

          # æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨
          if curl -f http://localhost:9999/health > /dev/null 2>&1; then
            END_TIME=$(date +%s%3N)
            STARTUP_TIME=$((END_TIME - START_TIME))
            echo "âœ… Server started in ${STARTUP_TIME}ms"

            if [ $STARTUP_TIME -gt 5000 ]; then
              echo "âš ï¸ Warning: Startup time > 5s"
              echo "startup_time=$STARTUP_TIME" >> $GITHUB_OUTPUT
            else
              echo "âœ… Startup time within acceptable range"
            fi
          else
            echo "âŒ Server failed to start"
            exit 1
          fi

          # æ¸…ç†
          kill $SERVER_PID 2>/dev/null || true

      - name: Memory usage check
        run: |
          echo "ðŸ“Š Checking memory usage..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ å†…å­˜ä½¿ç”¨æ£€æŸ¥

  # ç»¼åˆæ€§èƒ½æµ‹è¯•
  comprehensive-performance-test:
    name: Comprehensive Performance Test
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.test_type == 'comprehensive'
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup monitoring
        run: |
          echo "ðŸ“Š Setting up performance monitoring..."

          # åˆ›å»ºæ€§èƒ½åŸºå‡†ç›®å½•
          mkdir -p performance-results
          mkdir -p performance-baseline

      - name: Run server startup benchmark
        run: |
          echo "ðŸ Running startup performance benchmark..."

          # å¤šæ¬¡æµ‹è¯•å–å¹³å‡å€¼
          STARTUP_TIMES=()
          for i in {1..5}; do
            START_TIME=$(date +%s%3N)
            timeout 30s npm start > /dev/null 2>&1 &
            SERVER_PID=$!

            # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
            for j in {1..30}; do
              if curl -f http://localhost:9999/health > /dev/null 2>&1; then
                END_TIME=$(date +%s%3N)
                STARTUP_TIME=$((END_TIME - START_TIME))
                STARTUP_TIMES+=($STARTUP_TIME)
                echo "Run $i: ${STARTUP_TIME}ms"
                break
              fi
              sleep 1
            done

            # æ¸…ç†è¿›ç¨‹
            kill $SERVER_PID 2>/dev/null || true
            sleep 2
          done

          # è®¡ç®—ç»Ÿè®¡
          TOTAL=0
          for time in "${STARTUP_TIMES[@]}"; do
            TOTAL=$((TOTAL + time))
          done
          AVG_STARTUP=$((TOTAL / ${#STARTUP_TIMES[@]}))

          echo "ðŸ“ˆ Average startup time: ${AVG_STARTUP}ms"
          echo "startup_time=$AVG_STARTUP" >> $GITHUB_OUTPUT

          # ä¿å­˜ç»“æžœ
          echo "$AVG_STARTUP" > performance-results/startup-time.txt

      - name: Run API performance test
        run: |
          echo "ðŸ”¥ Running API performance tests..."

          # å¯åŠ¨æœåŠ¡å™¨
          npm start &
          SERVER_PID=$!
          sleep 5

          # ä½¿ç”¨autocannonè¿›è¡Œè´Ÿè½½æµ‹è¯•
          npx autocannon -c 10 -d 10 -R 100 http://localhost:9999/health > performance-results/api-load-test.txt

          # è§£æžç»“æžœ
          AVG_LATENCY=$(grep "Avg latency" performance-results/api-load-test.txt | awk '{print $3}' | sed 's/ms//')
          REQUESTS_PER_SEC=$(grep "Requests/sec" performance-results/api-load-test.txt | awk '{print $2}')

          echo "ðŸ“Š API Performance Results:"
          echo "- Average latency: ${AVG_LATENCY}ms"
          echo "- Requests/sec: $REQUESTS_PER_SEC"

          # æ¸…ç†
          kill $SERVER_PID 2>/dev/null || true

      - name: Run memory leak test
        run: |
          echo "ðŸ§  Running memory leak detection..."

          # å¯åŠ¨æœåŠ¡å™¨å¹¶ç›‘æŽ§å†…å­˜ä½¿ç”¨
          npm start &
          SERVER_PID=$!
          sleep 5

          # æ”¶é›†å†…å­˜ä½¿ç”¨æ•°æ®
          for i in {1..10}; do
            MEMORY_USAGE=$(ps -o rss= -p $SERVER_PID 2>/dev/null || echo "0")
            echo "$MEMORY_USAGE" >> performance-results/memory-usage.txt
            sleep 3
          done

          # æ£€æŸ¥å†…å­˜æ³„æ¼
          INITIAL_MEMORY=$(head -1 performance-results/memory-usage.txt)
          FINAL_MEMORY=$(tail -1 performance-results/memory-usage.txt)
          MEMORY_DIFF=$((FINAL_MEMORY - INITIAL_MEMORY))

          echo "ðŸ“ˆ Memory usage change: ${MEMORY_DIFF}KB"

          if [ $MEMORY_DIFF -gt 10000 ]; then
            echo "âš ï¸ Warning: Potential memory leak detected"
            echo "memory_leak=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Memory usage stable"
            echo "memory_leak=false" >> $GITHUB_OUTPUT
          fi

          # æ¸…ç†
          kill $SERVER_PID 2>/dev/null || true

      - name: Generate performance report
        run: |
          echo "## ðŸš€ Performance Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Startup Time**: ${{ steps.startup.outputs.startup_time }}ms" >> $GITHUB_STEP_SUMMARY
          echo "- **Memory Leak**: ${{ steps.memory.outputs.memory_leak == 'true' && 'âš ï¸ Detected' || 'âœ… None' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Performance Trends" >> $GITHUB_STEP_SUMMARY
          echo "Compare with baseline performance metrics." >> $GITHUB_STEP_SUMMARY

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: performance-results/

  # è´Ÿè½½æµ‹è¯•
  load-test:
    name: Load Testing
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'load-test'
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run load test
        run: |
          echo "ðŸ”¥ Executing comprehensive load test..."

          # å¯åŠ¨æœåŠ¡å™¨
          npm start &
          SERVER_PID=$!
          sleep 10

          # å¤šé˜¶æ®µè´Ÿè½½æµ‹è¯•
          echo "ðŸ“ˆ Phase 1: Warm-up (50 connections)"
          npx autocannon -c 50 -d 30 http://localhost:9999/health > load-test-phase1.txt

          echo "ðŸ“ˆ Phase 2: Medium load (200 connections)"
          npx autocannon -c 200 -d 60 http://localhost:9999/health > load-test-phase2.txt

          echo "ðŸ“ˆ Phase 3: High load (500 connections)"
          npx autocannon -c 500 -d 60 http://localhost:9999/health > load-test-phase3.txt

          # åˆ†æžç»“æžœ
          echo "ðŸ“Š Load Test Summary:"
          echo "Phase 1 - Avg Latency: $(grep 'Avg latency' load-test-phase1.txt | awk '{print $3}')"
          echo "Phase 2 - Avg Latency: $(grep 'Avg latency' load-test-phase2.txt | awk '{print $3}')"
          echo "Phase 3 - Avg Latency: $(grep 'Avg latency' load-test-phase3.txt | awk '{print $3}')"

          # æ¸…ç†
          kill $SERVER_PID 2>/dev/null || true

      - name: Upload load test results
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: load-test-*.txt

  # æ€§èƒ½åŸºå‡†æ¯”è¾ƒ
  performance-comparison:
    name: Performance Comparison
    runs-on: ubuntu-latest
    needs: comprehensive-performance-test
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download current results
        uses: actions/download-artifact@v4
        with:
          name: performance-results

      - name: Compare with baseline
        run: |
          echo "âš–ï¸ Comparing performance with baseline..."

          if [ -f "performance-baseline/startup-time.txt" ]; then
            BASELINE_TIME=$(cat performance-baseline/startup-time.txt)
            CURRENT_TIME=$(cat performance-results/startup-time.txt)

            DIFF=$((CURRENT_TIME - BASELINE_TIME))
            PERCENT_CHANGE=$((DIFF * 100 / BASELINE_TIME))

            echo "ðŸ“Š Performance Comparison:"
            echo "- Baseline: ${BASELINE_TIME}ms"
            echo "- Current: ${CURRENT_TIME}ms"
            echo "- Change: ${DIFF}ms (${PERCENT_CHANGE}%)"

            if [ $PERCENT_CHANGE -gt 10 ]; then
              echo "âš ï¸ Warning: Performance degraded by more than 10%"
              echo "performance_regression=true" >> $GITHUB_OUTPUT
            elif [ $PERCENT_CHANGE -lt -10 ]; then
              echo "ðŸŽ‰ Performance improved by more than 10%"
              echo "performance_improved=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… Performance within acceptable range"
            fi
          else
            echo "ðŸ“ Creating new baseline..."
            cp performance-results/startup-time.txt performance-baseline/startup-time.txt
          fi

      - name: Update baseline
        run: |
          # æ›´æ–°åŸºå‡†çº¿ï¼ˆä»…åœ¨mainåˆ†æ”¯ä¸Šï¼‰
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ðŸ’¾ Updating performance baseline..."
            cp performance-results/* performance-baseline/

            # æäº¤åŸºå‡†çº¿æ›´æ–°
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add performance-baseline/
            git commit -m "chore: update performance baseline [ci skip]" || true
            git push || true
          fi

      - name: Generate comparison report
        run: |
          echo "## âš–ï¸ Performance Comparison Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance Regression**: ${{ steps.compare.outputs.performance_regression == 'true' && 'âš ï¸ Detected' || 'âœ… None' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance Improvement**: ${{ steps.compare.outputs.performance_improved == 'true' && 'ðŸŽ‰ Detected' || 'âœ… None' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Recommendations" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.compare.outputs.performance_regression }}" == "true" ]]; then
            echo "- Investigate performance degradation" >> $GITHUB_STEP_SUMMARY
            echo "- Review recent code changes" >> $GITHUB_STEP_SUMMARY
            echo "- Consider performance optimizations" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Performance metrics look good!" >> $GITHUB_STEP_SUMMARY
          fi
