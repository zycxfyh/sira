version: '3.8'

# 测试环境配置
# 包含集成测试和E2E测试所需的完整服务栈

services:
  # AI Gateway 测试实例
  ai-gateway-test:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: sira-ai-gateway-test
    environment:
      - NODE_ENV=test
      - PORT=8080
      - LOG_LEVEL=error
      # 测试数据库配置
      - DATABASE_URL=postgresql://test:test_password@postgres-test:5432/sira_test
      - REDIS_URL=redis://redis-test:6379
      # 消息队列
      - RABBITMQ_URL=amqp://test:test_password@rabbitmq-test:5672/
      # 测试API Keys (使用测试密钥)
      - DEEPSEEK_API_KEY=sk-test-key-for-testing
      - OPENAI_API_KEY=sk-test-key-for-testing
      # 测试配置
      - TEST_MODE=true
      - JEST_TIMEOUT=30000
    ports:
      - "8080:8080"
    networks:
      - sira-test-network
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
      rabbitmq-test:
        condition: service_healthy
    restart: "no"  # 测试完成后自动停止
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    command: npm run start

  # PostgreSQL 测试数据库
  postgres-test:
    image: postgres:15-alpine
    container_name: sira-postgres-test
    environment:
      POSTGRES_DB: sira_test
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test_password
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    volumes:
      - ./docker/postgres/init-test.sql:/docker-entrypoint-initdb.d/init-test.sql:ro
    ports:
      - "5434:5432"  # 避免与其他实例冲突
    networks:
      - sira-test-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test -d sira_test"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    tmpfs:
      - /var/lib/postgresql/data  # 使用内存存储，提高测试速度
    command: >
      postgres
      -c max_connections=50
      -c shared_buffers=128MB
      -c fsync=off
      -c synchronous_commit=off
      -c full_page_writes=off

  # Redis 测试缓存
  redis-test:
    image: redis:7-alpine
    container_name: sira-redis-test
    volumes:
      - ./docker/redis/redis-test.conf:/etc/redis/redis.conf:ro
    ports:
      - "6381:6379"  # 避免冲突
    networks:
      - sira-test-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    command: redis-server /etc/redis/redis.conf

  # RabbitMQ 测试消息队列
  rabbitmq-test:
    image: rabbitmq:3-management-alpine
    container_name: sira-rabbitmq-test
    environment:
      RABBITMQ_DEFAULT_USER: test
      RABBITMQ_DEFAULT_PASS: test_password
      RABBITMQ_DEFAULT_VHOST: /
    volumes:
      - rabbitmq_test_data:/var/lib/rabbitmq
    ports:
      - "5674:5672"    # AMQP
      - "15674:15672"  # Management UI
    networks:
      - sira-test-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Playwright E2E测试运行器
  playwright-tests:
    image: mcr.microsoft.com/playwright:v1.40.0-focal
    container_name: sira-playwright-tests
    working_dir: /app
    volumes:
      - .:/app:cached
      - /app/node_modules
      - playwright_results:/app/test-results
    environment:
      - CI=true
      - BASE_URL=http://ai-gateway-test:8080
    networks:
      - sira-test-network
    depends_on:
      ai-gateway-test:
        condition: service_healthy
    restart: "no"
    command: >
      sh -c "
        npm ci &&
        npx playwright install &&
        npx playwright test --headed=false --reporter=json
      "
    profiles:
      - e2e

  # API集成测试运行器
  api-tests:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: sira-api-tests
    working_dir: /app
    volumes:
      - .:/app:cached
      - /app/node_modules
      - test_results:/app/test-results
    environment:
      - NODE_ENV=test
      - API_BASE_URL=http://ai-gateway-test:8080
      - TEST_TYPE=integration
    networks:
      - sira-test-network
    depends_on:
      ai-gateway-test:
        condition: service_healthy
    restart: "no"
    command: npm run test:integration
    profiles:
      - integration

  # 负载测试运行器
  load-tests:
    image: grafana/k6:latest
    container_name: sira-load-tests
    working_dir: /app
    volumes:
      - .:/app:cached
      - load_test_results:/app/load-test-results
    environment:
      - K6_BASE_URL=http://ai-gateway-test:8080
    networks:
      - sira-test-network
    depends_on:
      ai-gateway-test:
        condition: service_healthy
    restart: "no"
    command: k6 run --out json=load-test-results/results.json load-tests/smoke.js
    profiles:
      - load

  # 测试覆盖率报告生成器
  coverage-reporter:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: sira-coverage-reporter
    working_dir: /app
    volumes:
      - .:/app:cached
      - /app/node_modules
      - coverage_reports:/app/coverage-reports
    environment:
      - NODE_ENV=test
      - CI=true
    networks:
      - sira-test-network
    restart: "no"
    command: >
      sh -c "
        npm run test:coverage &&
        npx nyc report --reporter=lcov --reporter=text --reporter=json
      "
    profiles:
      - coverage

networks:
  sira-test-network:
    driver: bridge
    name: sira-test-network
    internal: false  # 允许外部访问以进行调试

volumes:
  rabbitmq_test_data:
    driver: local
  playwright_results:
    driver: local
  test_results:
    driver: local
  load_test_results:
    driver: local
  coverage_reports:
    driver: local
