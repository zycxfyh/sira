<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="admin.title">Sira AIç½‘å…³ - ç®¡ç†é¢æ¿</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 8px; margin-bottom: 20px; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .metric { text-align: center; margin-bottom: 15px; }
        .metric-value { font-size: 2em; font-weight: bold; color: #495057; }
        .metric-label { color: #6c757d; font-size: 0.9em; }
        .status-good { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        .chart-container { height: 200px; background: #f8f9fa; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #6c757d; }
        .refresh-btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-bottom: 20px; }
        .refresh-btn:hover { background: #0056b3; }
        .loading { display: none; color: #6c757d; font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 data-i18n="admin.header.title">ğŸš€ Sira AIç½‘å…³ç®¡ç†é¢æ¿</h1>
            <p data-i18n="admin.header.subtitle">ç³»ç»Ÿç›‘æ§å’Œä¸šåŠ¡æŒ‡æ ‡æ¦‚è§ˆ</p>
        </div>

        <button class="refresh-btn" onclick="refreshDashboard()" data-i18n="admin.refresh">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        <div class="loading" id="loading" data-i18n="admin.loading">æ­£åœ¨åŠ è½½...</div>

        <div class="dashboard" id="dashboard">
            <!-- ä»ªè¡¨æ¿å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <script>
        let dashboardData = null;
        let i18n = {};

        // ç®€å•çš„i18nå®ç°
        async function loadI18n() {
            try {
                const response = await fetch('/api/system/language');
                const lang = await response.json();
                const langResponse = await fetch(`/locales/${lang}.json`);
                i18n = await langResponse.json();
                applyI18n();
            } catch (error) {
                console.warn('Failed to load i18n:', error);
            }
        }

        function t(key, fallback) {
            return i18n[key] || fallback || key;
        }

        function applyI18n() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key, el.textContent);
            });
        }

        async function loadDashboard() {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            try {
                const response = await fetch('/api/admin/dashboard');
                dashboardData = await response.json();
                renderDashboard();
            } catch (error) {
                console.error('åŠ è½½ä»ªè¡¨æ¿æ•°æ®å¤±è´¥:', error);
                showError('æ— æ³•åŠ è½½ä»ªè¡¨æ¿æ•°æ®');
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderDashboard() {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = '';

            if (!dashboardData) return;

            // ç³»ç»Ÿå¥åº·çŠ¶æ€å¡ç‰‡
            if (dashboardData.system) {
                const systemCard = createSystemCard(dashboardData.system);
                dashboard.appendChild(systemCard);
            }

            // ä¸šåŠ¡æŒ‡æ ‡å¡ç‰‡
            if (dashboardData.business) {
                const businessCards = createBusinessCards(dashboardData.business);
                businessCards.forEach(card => dashboard.appendChild(card));
            }

            // å›¾è¡¨å ä½ç¬¦
            const chartCard = document.createElement('div');
            chartCard.className = 'card';
            chartCard.innerHTML = `
                <h3>${t('admin.charts.title', 'ğŸ“Š æ€§èƒ½è¶‹åŠ¿')}</h3>
                <div class="chart-container">
                    ${t('admin.charts.placeholder', 'å›¾è¡¨åŠŸèƒ½å¼€å‘ä¸­...')}
                </div>
            `;
            dashboard.appendChild(chartCard);
        }

        function createSystemCard(system) {
            const card = document.createElement('div');
            card.className = 'card';

            const statusClass = getStatusClass(system.status);
            const statusText = getStatusText(system.status);

            card.innerHTML = `
                <h3>${t('admin.system.title', 'ğŸ–¥ï¸ ç³»ç»Ÿå¥åº·çŠ¶æ€')}</h3>
                <div class="metric">
                    <div class="metric-value ${statusClass}">${statusText}</div>
                    <div class="metric-label">${t('admin.system.overall_status', 'æ•´ä½“çŠ¶æ€')}</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${system.metrics?.memoryUsage || 'N/A'}</div>
                    <div class="metric-label">${t('admin.system.memory_usage', 'å†…å­˜ä½¿ç”¨ç‡')}</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${system.metrics?.cpuUsage || 'N/A'}</div>
                    <div class="metric-label">${t('admin.system.cpu_usage', 'CPUä½¿ç”¨ç‡')}</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${system.metrics?.uptime ? Math.floor(system.metrics.uptime / 3600) + 'h' : 'N/A'}</div>
                    <div class="metric-label">${t('admin.system.uptime', 'è¿è¡Œæ—¶é—´')}</div>
                </div>
            `;

            return card;
        }

        function createBusinessCards(business) {
            const cards = [];

            // è·¯ç”±æŒ‡æ ‡å¡ç‰‡
            if (business.routing) {
                const routingCard = document.createElement('div');
                routingCard.className = 'card';
                routingCard.innerHTML = `
                    <h3>${t('admin.routing.title', 'ğŸ¯ AIè·¯ç”±æ€§èƒ½')}</h3>
                    <div class="metric">
                        <div class="metric-value">${business.routing.totalRequests}</div>
                        <div class="metric-label">${t('admin.routing.total_requests', 'æ€»è¯·æ±‚æ•°')}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value status-good">${business.routing.successRate}</div>
                        <div class="metric-label">${t('admin.routing.success_rate', 'æˆåŠŸç‡')}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${business.routing.topProviders?.[0]?.[0] || 'N/A'}</div>
                        <div class="metric-label">${t('admin.routing.top_provider', 'ä¸»è¦æä¾›å•†')}</div>
                    </div>
                `;
                cards.push(routingCard);
            }

            // æˆæœ¬æŒ‡æ ‡å¡ç‰‡
            if (business.costs) {
                const costCard = document.createElement('div');
                costCard.className = 'card';
                costCard.innerHTML = `
                    <h3>${t('admin.cost.title', 'ğŸ’° æˆæœ¬ç›‘æ§')}</h3>
                    <div class="metric">
                        <div class="metric-value">${business.costs.totalCost}</div>
                        <div class="metric-label">${t('admin.cost.total_cost', 'æ€»æˆæœ¬')}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${business.costs.avgCostPerRequest}</div>
                        <div class="metric-label">${t('admin.cost.avg_cost_per_request', 'å¹³å‡è¯·æ±‚æˆæœ¬')}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${business.costs.costByProvider?.[0]?.[0] || 'N/A'}</div>
                        <div class="metric-label">${t('admin.cost.highest_cost_provider', 'æœ€é«˜æˆæœ¬æä¾›å•†')}</div>
                    </div>
                `;
                cards.push(costCard);
            }

            // ç”¨æˆ·æŒ‡æ ‡å¡ç‰‡
            if (business.users) {
                const userCard = document.createElement('div');
                userCard.className = 'card';
                userCard.innerHTML = `
                    <h3>${t('admin.users.title', 'ğŸ‘¥ ç”¨æˆ·ç»Ÿè®¡')}</h3>
                    <div class="metric">
                        <div class="metric-value">${business.users.activeUsers}</div>
                        <div class="metric-label">${t('admin.users.active_users', 'æ´»è·ƒç”¨æˆ·')}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${business.users.avgRequestsPerUser}</div>
                        <div class="metric-label">${t('admin.users.avg_requests_per_user', 'å¹³å‡è¯·æ±‚/ç”¨æˆ·')}</div>
                    </div>
                `;
                cards.push(userCard);
            }

            return cards;
        }

        function getStatusClass(status) {
            switch (status) {
                case 'healthy': return 'status-good';
                case 'warning': return 'status-warning';
                case 'critical': case 'error': return 'status-error';
                default: return '';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'healthy': return t('admin.status.healthy', 'å¥åº·');
                case 'warning': return t('admin.status.warning', 'è­¦å‘Š');
                case 'critical': return t('admin.status.critical', 'ä¸¥é‡');
                case 'unknown': return t('admin.status.unknown', 'æœªçŸ¥');
                default: return status;
            }
        }

        function showError(message) {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = `
                <div class="card">
                    <h3>${t('admin.error.title', 'âŒ é”™è¯¯')}</h3>
                    <p>${message}</p>
                    <button onclick="loadDashboard()">${t('admin.error.retry', 'é‡è¯•')}</button>
                </div>
            `;
        }

        function refreshDashboard() {
            loadDashboard();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            await loadI18n();
            loadDashboard();
        });

        // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
        setInterval(refreshDashboard, 30000);
    </script>
</body>
</html>
