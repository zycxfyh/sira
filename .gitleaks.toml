# Gitleaks Configuration for Advanced Secret Detection
# This configuration provides comprehensive secret scanning rules

title = "Sira Gateway Secret Detection"

# 全局配置
[extend]
useDefault = true

# 自定义规则
[[rules]]
id = "custom-api-key"
description = "Custom API Key Pattern"
regex = '''(?i)(api[_-]?key|apikey|api_key)\s*[:=]\s*['"]?([a-zA-Z0-9_-]{20,})['"]?'''
secretGroup = 2
entropy = 3.5
keywords = ["api_key", "apikey", "api-key"]

[[rules]]
id = "custom-jwt-token"
description = "JWT Token Pattern"
regex = '''eyJ[A-Za-z0-9-_]+\.eyJ[A-Za-z0-9-_]+\.[A-Za-z0-9-_.+=]+'''
keywords = ["jwt", "token", "bearer"]

[[rules]]
id = "custom-database-url"
description = "Database Connection URL"
regex = '''(?i)(mongodb|postgresql|mysql|redis)://[^:/@]+:[^@]+@[^/]+'''
keywords = ["mongodb://", "postgresql://", "mysql://", "redis://"]

# 排除文件和路径 - 更安全的配置
[allowlist]
description = "Allowlisted files and paths"
files = [
    # 文档文件 - 通常不包含敏感信息
    '''.*\.md$''',
    '''README.*''',

    # 特定配置文件 - 明确列出安全的文件
    '''package\.json$''',
    '''package-lock\.json$''',
    '''yarn\.lock$''',
    '''tsconfig\.json$''',
    '''jest\.config\.js$''',

    # 测试和示例文件 - 明确路径限制
    '''test/fixtures/.*\.json$''',
    '''test/mocks/.*\.json$''',
    '''src/test/.*\.json$''',
    '''examples/.*\.json$''',
    '''samples/.*\.json$''',

    # 配置文件 - 只允许根目录的特定文件
    '''^config\.yml$''',
    '''^gateway\.config\.yml$''',
    '''^system\.config\.yml$''',

    # 其他安全文件类型
    '''.*\.txt$'''
]
paths = [
    '''node_modules''',
    '''\.git''',
    '''reports''',
    '''coverage''',
    '''test-results''',
    '''\.github/workflows''',
    '''docs''',
    '''infrastructure''',
    '''docker''',
    '''scripts''',
    '''tools''',

    # 安全检查：不再排除配置目录，允许扫描所有配置文件
    # 配置目录现在会被扫描以检测硬编码的秘密

    # 排除测试目录
    '''test/''',
    '''tests/''',
    '''spec/''',
    '''__tests__/''',

    # 排除示例和演示目录
    '''examples/''',
    '''samples/''',
    '''demo/''',

    # 排除构建产物
    '''dist/''',
    '''build/''',
    '''out/'''
]

# 排除熵值较低的内容
[[allowlist.regexes]]
description = "Allow short strings and common patterns"
regexes = [
    '''^[a-zA-Z0-9_-]{1,10}$''',
    '''^test[_-]?key$''',
    '''^example[_-]?key$''',
    '''^dummy[_-]?key$''',
    '''^placeholder[_-]?key$'''
]
