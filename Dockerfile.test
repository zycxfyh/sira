# 测试环境Docker镜像
# 专门为运行测试套件优化的镜像

FROM node:18-alpine

# 安装测试所需的系统依赖
RUN apk add --no-cache \
    curl \
    bash \
    postgresql-client \
    redis \
    && npm install -g pnpm

# 设置工作目录
WORKDIR /app

# 复制package文件
COPY package.json pnpm-lock.yaml ./

# 安装所有依赖（包括测试依赖）
RUN pnpm install --frozen-lockfile

# 复制源代码和测试文件
COPY src/ ./src/
COPY test/ ./test/
COPY *.config.js ./
COPY jest.* ./
COPY playwright.config.js ./
COPY test-*.js ./

# 创建测试输出目录
RUN mkdir -p /app/test-results /app/coverage /app/.nyc_output

# 设置测试环境变量
ENV NODE_ENV=test
ENV CI=true
ENV JEST_TIMEOUT=30000

# 暴露端口（如果需要调试）
EXPOSE 8080

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# 默认启动测试服务（可以被覆盖）
CMD ["npm", "run", "start"]
